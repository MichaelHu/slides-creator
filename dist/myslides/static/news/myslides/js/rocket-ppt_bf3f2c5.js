define(["require","jquery","zepto","rocket"],function(e,t,n,i){var a=void 0,o={};n(document).on("touchmove",function(e){e.preventDefault()}),!function(){function e(e,t){var i,a,o,s,l,r,c=n(e),g=t||{};c.on("touchstart.draggable",function(e){var t=e.touches[0];l=o=i=t.clientX,r=s=a=t.clientY,g.ondragstart&&g.ondragstart(),e.stopPropagation(),e.preventDefault(),c.on("touchmove",function(e){var t=e.touches[0];o=l,s=r,l=t.clientX,r=t.clientY,g.ondrag&&g.ondrag(l-o,r-s,l-i,r-a),e.stopPropagation(),e.preventDefault()
}).on("touchend",function(e){g.ondragend&&g.ondragend(),e.stopPropagation(),e.preventDefault(),c.off("touchmove touchend")})})}function t(e){n(e).off(".draggable")}n.fn.enableDrag=function(t){e(this[0],t)},n.fn.disableDrag=function(){t(this[0])}}();var s=i.GlobalView.extend({className:"global-panel",events:{"tap .panel span":"onpanelbuttonclick"},contTpl:['<div class="panel-wrapper">','<div class="panel iconfont">','<span class="panel-bottom icon-xiangxia"></span>','<span class="panel-top icon-xiangshang1"></span>','<span class="slide-new icon-jia1"></span>','<span class="slide-delete icon-jian1"></span>','<span class="slide-prev icon-xiangzuo2"></span>','<span class="slide-next icon-xiangyou2"></span>','<span class="slide-config icon-shezhi"></span>','<span class="text-new icon-wenbenshuru"></span>','<span class="topnewsimagetext-new icon-wenbenshuru"></span>','<span class="image-new icon-tupian"></span>','<span class="image-withmask-new icon-tupian"></span>','<span class="image-topnews-withmask-new icon-tupian"></span>','<span class="image-button-new">图</span>','<span class="image-button-1-new">图</span>','<span class="image-button-2-new">图</span>','<span class="button-share-new">享</span>','<span class="button-release-new">发</span>','<span class="button-link-new">链</span>','<span class="button-link-1-new">链</span>','<span class="boxalign-left icon-juzuo"></span>','<span class="boxalign-center icon-juzhong"></span>','<span class="boxalign-right icon-juyou"></span>','<span class="boxalign-bottom">底</span>','<span class="boxalign-left-a icon-juzuo"></span>','<span class="boxalign-center-a icon-juzhong"></span>','<span class="boxalign-right-a icon-juyou"></span>','<span class="boxalign-bottom-a">底</span>','<span class="layer-up icon-xiangshang"></span>','<span class="layer-down icon-paixu"></span>','<span class="align-left icon-juzuo"></span>','<span class="align-center icon-juzhong"></span>','<span class="align-right icon-juyou"></span>','<span class="font-color icon-ziti"></span>','<span class="zoom-in icon-fangda"></span>','<span class="zoom-out icon-suoxiao"></span>','<span class="preview icon-dianshiji"></span>','<span class="save icon-baocun"></span>','<span class="save4partialedit icon-shangchuan"></span>','<span class="release icon-fasong"></span>',"</div>","</div>"].join(""),init:function(){var e=this;
e.render(),e.$panel=e.$(".panel"),"FULLEDIT"==e.gec.editMode?e.initIScroll():e.hide()},registerEvents:function(){var e=this,t=e.gec;t.on("routechange",e.onroutechange,e),t.on("beforeedit.global",e.onbeforeedit,e),t.on("beforeimageedit.global",e.onbeforeimageedit,e),t.on("release.releasebutton.global",e.onreleasefromreleasebutton,e)},render:function(){var e=this;e.$el.html(e.contTpl).appendTo("body"),e.positionPanel("bottom")},initIScroll:function(){var e=this;e.iScroll=new IScroll(e.$(".panel-wrapper")[0],{scrollX:!0,scrollY:!1,mouseWheel:!0,bounnce:!0}),setTimeout(function(){e.refreshIScroll()
},200)},refreshIScroll:function(){var e=this,t=0,i=e.$panel;n.each(i.children(),function(e,i){var a=n(i);t+=a.width()}),t+=16*parseInt(e.$(".boxalign-center").css("margin-left")),setTimeout(function(){i.width(t),setTimeout(function(){e.iScroll.refresh()},100)},300)},onroutechange:function(e){this.currentAction=e.to.action},clearState:function(){this.gec.trigger("clear.global",{target:this})},onpanelbuttonclick:function(e){var t=this,i=n(e.target).closest("span"),a=i[0].className;if(i.addClass("on"),setTimeout(function(){i.removeClass("on")
},300),/^align-(\w+)/.test(a)){var o=RegExp.$1;t.gec.trigger("textalign.global",{textAlign:o})}else if(/^boxalign-((left|right|center|bottom)(-a)?)/.test(a))t.gec.trigger("boxalign.global",{type:RegExp.$1});else if(/panel-(bottom|top)/.test(a))t.clearState(),t.positionPanel(RegExp.$1);else if(/slide-new/.test(a))t.clearState(),t.toggleSlideNewPanel();else if(/slide-config/.test(a))t.clearState(),t.toggleSlideConfigPanel();else if(/slide-(next|prev|delete)/.test(a)){var s=RegExp.$1;t.clearState(),t.gec.trigger("slideoperation.global",{action:s})
}else if(/layer-(up|down)/.test(a)){var s=RegExp.$1;t.gec.trigger("layer.global",{action:s})}else if(/(text|topnewsimagetext)-new/.test(a)){var s=RegExp.$1;t.clearState(),t.gec.trigger("newtext.global",{type:s})}else if(/image-(|withmask|topnews-withmask|button|button-\d)-?new/.test(a)){var s=RegExp.$1;t.clearState(),t.togglePopupImagePanel({imageType:s})}else if(/button-(release|share|image|link|link-1)-new/.test(a)){var s=RegExp.$1;t.clearState(),t.gec.trigger("newbutton.global",{type:s})}else if(/font-color/.test(a))t.toggleFontColorPanel();
else if(/zoom-(in|out)/.test(a)){var s=RegExp.$1;t.gec.trigger("zoom.global",{action:s})}else if(/preview/.test(a))t.clearState(),t.gec.trigger("clear.global preview.global"),t.previewSlides();else if(/save4partialedit|release|save/.test(a)){var s=RegExp["$&"];t.onsave(s)}},onsave:function(e){var t=this,n={order:t.gec.pageOrder,views:{},images:[],topNewsImage:{},isRelease:"release"==e?!0:!1,editMode:"save4partialedit"==e?"PARTIALEDIT":"save"==e?"FULLEDIT":"RELEASE"};return t.isPreviewed||t.gec.isAllPagesOpened()?(t.gec.trigger("clear.global").trigger(e+".global",n.views,n.images,n.topNewsImage),void t.saveSlides(n,e)):(t.tip("Please preview first."),void setTimeout(function(){t.previewSlides(function(){t.onsave(e)
})},1e3))},onreleasefromreleasebutton:function(){this.onsave("release")},onbeforeedit:function(e){this.togglePopupEditPanel(e)},onbeforeimageedit:function(e){n.extend(e,{isEditing:!0}),this.togglePopupImagePanel(e)},toggleFontColorPanel:function(){var e=this,t=e.fontColorPanel;t||(t=e.fontColorPanel=new c(null,e),e.appendTo(t,"body")),t.toggle()},toggleSlideNewPanel:function(){var e=this,t=e.slideNewPanel;t||(t=e.slideNewPanel=new u(null,e),e.appendTo(t,"body")),t.toggle()},toggleSlideConfigPanel:function(){var e=this,t=e.slideConfigPanel;
t||(t=e.slideConfigPanel=new p(null,e),e.appendTo(t,"body")),t.toggle()},togglePopupImagePanel:function(e){var t=this,n=t.popupImagePanel;n||(n=t.popupImagePanel=new g(null,t),t.appendTo(n,"body")),n.toggle(e)},togglePopupEditPanel:function(e){var t=this,n=t.popupEditPanel;n||(n=t.popupEditPanel=new r(null,t),t.appendTo(n,"body")),console.log(111),n.toggle(e&&e.text||{}.text)},positionPanel:function(e){var t=this;"top"==e&&t.$el.css({top:0,bottom:"auto"}),"bottom"==e&&t.$el.css({bottom:0,top:"auto"})
},previewSlides:function(e){function t(){a<i.length?(n.navigate(i[a++]),setTimeout(function(){t()},2e3)):(n.tip("Preview finish."),setTimeout(function(){e&&e()},1e3))}var n=this,i=n.gec.pageOrder,a=0;n.tip("Preview start."),t(),n.isPreviewed=!0},saveSlides:function(e,t){var n=this,i=e.topNewsImage;console.log(escape(JSON.stringify(e))),n.ensureSendForm(),n.$inputContent.val(escape(JSON.stringify(e))),n.$inputImgUrl.val(i.img_url),n.$inputImgWidth.val(i.img_width),n.$inputImgHeight.val(i.img_height),n.$inputTitle.val(i.title),n.$form.submit(),window.__cardAsyncCallback__=function(e){var a;
if(!e||e.cardid){switch(t){case"save4partialedit":a="./partialedit.html";break;case"release":a="./index.html","PARTIALEDIT"==n.gec.editMode&&(a="http://m.baidu.com/news");break;case"save":a="./fulledit.html"}location.href=a+"?cardid="+e.cardid+"&cut_x="+(i.x||0)+"&cut_y="+(i.y||0)+"&cut_w="+(i.w||640)+"&cut_h="+(i.h||400)}}},ensureSendForm:function(){var e=this,t=e.$form,i=['<form action="'+global_greetingcard_server+'"',' method="POST" target="__hidden_iframe__">','<input name="action" type="hidden" value="add">','<input name="cuid" type="hidden" value="cuid">','<input name="redirect" type="hidden"',' value="'+global_land_page+'">','<input name="maxwidth" type="hidden" value="800">','<input name="name" type="hidden" value="name">','<input name="title" type="hidden" value="title">','<input name="template" type="hidden" value="template">','<input name="content" type="hidden" value="content">','<input name="img_url" type="hidden" value="http://myslides.baidu.com">','<input name="img_width" type="hidden" value="1200">','<input name="img_height" type="hidden" value="600">',"</form>"].join("");
t||(e._ensureHiddenIFrame(),t=e.$form=n(i).appendTo("body").hide(),e.$inputName=t.find('input[name="name"]'),e.$inputTitle=t.find('input[name="title"]'),e.$inputContent=t.find('input[name="content"]'),e.$inputImgUrl=t.find('input[name="img_url"]'),e.$inputImgWidth=t.find('input[name="img_width"]'),e.$inputImgHeight=t.find('input[name="img_height"]'))},_ensureHiddenIFrame:function(){n("#__hidden_iframe__").length||n('<iframe id="__hidden_iframe__" name="__hidden_iframe__" style="display:none;"></iframe>').appendTo("body")
}}),l=i.SubView.extend({className:"popup",init:function(e){this._super(e),this.render()},render:function(){this.$el.css({position:"fixed","z-index":999,top:0,left:0,bottom:0,right:0,"background-color":"rgba(0,0,0,0.7)"})},registerEvents:function(){var e=this;e.$el.on("click",function(){e.close()})},open:function(){this.$el.show()},close:function(){this.$el.hide()},toggle:function(){this.$el.toggle()}}),r=l.extend({init:function(e){var t=this;t._super(e),t.$popupEdit=t.$(".popup-edit-subview"),t.$text=t.$("textarea"),t.$confirmButton=t.$(".confirm")
},popupEditTpl:['<div class="popup-edit-subview">',"<textarea></textarea>",'<div class="confirm">确定</div>',"</div>"].join(""),render:function(){var e=this;e._super(),e.$el.append(e.popupEditTpl)},registerEvents:function(){var e=this;e._super(),e.$popupEdit.on("click",function(e){e.stopPropagation()}),e.$confirmButton.on("click",function(t){t.stopPropagation(),e.gec.trigger("afteredit.global",{text:e._decodeText(e.$text.val())}),e.close()})},setValue:function(e){void 0!==e&&this.$text.val(this._encodeText(e))
},toggle:function(e){var t=this;t._super(),"none"!=t.$el.css("display")?t.open(e):t.close()},open:function(e){this._super(),this.setValue(e)},_encodeText:function(e){return e.replace(/<br *\/?>/g,"\n").replace(/&nbsp;/g," ")},_decodeText:function(e){return console.log(e),e.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/(法|fa).*(轮|lun).*(大法)*|习近平|李克强|(六|liu|6)(四|si|4)/g,"*")}}),c=l.extend({init:function(e){var t=this;t._super(e),t.$panel=t.$(".popupfontcolor")},popupFontColorTpl:['<div class="popupfontcolor">','<div class="color"><b>颜色</b><input></div>','<div class="font-size">',"<b>字号</b>","<div>","<span>12px</span>","<span>14px</span>","<span>16px</span>","<span>18px</span>","<span>20px</span>","<span>22px</span>","<span>24px</span>","<span>26px</span>","<span>28px</span>","<span>30px</span>","<span>32px</span>","<span>34px</span>","<span>36px</span>","<span>38px</span>","<span>40px</span>","<span>42px</span>","<span>48px</span>","<span>56px</span>","<span>64px</span>","<span>72px</span>","<span>80px</span>","<span>90px</span>","<span>100px</span>","<span>120px</span>","</div>","</div>",'<div class="line-height">',"<b>行高</b>","<div>","<span>12px</span>","<span>14px</span>","<span>16px</span>","<span>18px</span>","<span>20px</span>","<span>22px</span>","<span>24px</span>","<span>26px</span>","<span>28px</span>","<span>30px</span>","<span>32px</span>","<span>34px</span>","<span>36px</span>","<span>38px</span>","<span>40px</span>","<span>42px</span>","<span>48px</span>","<span>56px</span>","<span>64px</span>","<span>72px</span>","<span>80px</span>","<span>90px</span>","<span>100px</span>","<span>120px</span>","</div>","</div>","</div>"].join(""),onfontsizeclick:function(e){var t,i=this,a=n(e.target);
(t=a.closest("span")).length&&i.gec.trigger("fontsize.global",{fontSize:t.html()})},onlineheightclick:function(e){var t,i=this,a=n(e.target);(t=a.closest("span")).length&&i.gec.trigger("lineheight.global",{lineHeight:t.html()})},render:function(){var e=this;return e._super(),e.$el.html(e.popupFontColorTpl),e.createColorPicker(),e},registerEvents:function(){var e=this;e._super(),e.$panel.on("click",function(e){e.stopPropagation()}),e.$(".font-size").on("click",function(t){e.onfontsizeclick(t)}),e.$(".line-height").on("click",function(t){e.onlineheightclick(t)
})},createColorPicker:function(){var e=this,n="#67890a";t(e.$("input")[0]).css("color",n).spectrum({color:n,showInput:!0,preferredFormat:"hex3",clickoutFiresChange:!0,showPalette:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],change:function(t){e.gec.trigger("color.global",{color:t.toHexString()})
}})}}),g=l.extend({init:function(e){var t,n=this;n._super(e),n.$popupImage=n.$(".popup-image-subview"),n.$tab=n.$(".tab"),t=n.defaultType=n.options.defaultType||"local","FULLEDIT"==n.gec.editMode?n.$tab.show():n.$tab.hide(),n.updateTab(t).openSubPanel(t)},popupImageTpl:['<div class="popup-image-subview">','<div class="tab">','<div class="tab-item" data-type="url">图片地址</div>','<div class="tab-item" data-type="local">本地上传</div>',"</div>","</div>"].join(""),render:function(){var e=this;e._super(),e.$el.append(e.popupImageTpl)
},registerEvents:function(){var e=this;e._super(),e.$popupImage.on("click",function(e){e.stopPropagation()}),e.$tab.on("click",function(t){var i,a=n(t.target).closest(".tab-item");a.length&&(e.$(".tab-item").removeClass("on"),a.addClass("on"),i=a.data("type"),e.openSubPanel(i),e.trigger("typechange",{type:i}))}),e.on("confirm",e.onconfirm,e)},onconfirm:function(e){var t=this;t.isEditing?(t.gec.trigger("imagechange.global",e),t.isEditing=!1):t.gec.trigger("newimage.global",n.extend(e,{type:t.imageType})),t.close()
},updateTab:function(e){var t=this;return t.$(".tab-item").each(function(t,i){var a=n(i);a.data("type")==e?a.addClass("on"):a.removeClass("on")}),t},openSubPanel:function(e){var t,n=this;switch(e){case"url":n.imageUrlPanel||(t=n.imageUrlPanel=new f(null,n),n.appendTo(t,n.$popupImage));break;case"local":n.imageUploadPanel||(t=n.imageUploadPanel=new d(null,n),n.appendTo(t,n.$popupImage))}return t&&t.open(),n},setValue:function(e){void 0!==e&&this.trigger("editimage",{url:e})},toggle:function(e){var t=this;
t._super(e),e.imageType&&(t.imageType=e.imageType),e&&e.isEditing&&(t.isEditing=!0),"none"!=t.$el.css("display")?t.open(e&&e.url):t.close()},open:function(e){this._super(),this.setValue(e)},close:function(){var e=this;e._super(),e.gec.trigger("afterimage.global",{src:""})}}),p=l.extend({init:function(e){var t=this;t._super(e),t.$panel=t.$(".popupslideconfig")},popupSlideConfigTpl:['<div class="popupslideconfig">','<div class="color"><b>背景颜色</b><input></div>',"</div>"].join(""),render:function(){var e=this;
return e._super(),e.$el.html(e.popupSlideConfigTpl),e.createColorPicker(),e},registerEvents:function(){var e=this;e._super(),e.$panel.on("click",function(e){e.stopPropagation()})},createColorPicker:function(){var e=this,n="#67890a";t(e.$("input")[0]).css("color",n).spectrum({color:n,showInput:!0,preferredFormat:"hex3",clickoutFiresChange:!0,showPalette:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],change:function(t){e.gec.trigger("slidebgcolor.global",{color:t.toHexString()})
}})}}),u=l.extend({init:function(e){var t=this;t._super(e),t.$panel=t.$(".slidenewpanel")},slideNewTpl:['<div class="slidenewpanel">','<div class="tpl-cont" data-type="plain">','<div class="tpl-thumbnail"></div>','<div class="tpl-info">空白页</div>',"</div>",'<div class="tpl-cont" data-type="editonly">','<div class="tpl-thumbnail"></div>','<div class="tpl-info">仅编辑</div>',"</div>",'<div class="tpl-cont" data-type="front">','<div class="tpl-thumbnail"></div>','<div class="tpl-info">贺卡页</div>',"</div>","</div>"].join(""),render:function(){var e=this;
return e._super(),e.$el.html(e.slideNewTpl),e},registerEvents:function(){var e=this;e._super(),e.$panel.on("click",function(t){t.stopPropagation(),e.onpanelclick(t),setTimeout(function(){e.close()},200)})},onpanelclick:function(e){var t,i=this,a=n(e.target).closest(".tpl-cont"),o="slide"+i.getUniqueSlideID();switch(a.data("type")){case"plain":t=m;break;case"front":t=x;break;case"editonly":t=$;break;default:t=m}i.gec.trigger("slideoperation.global",{action:"new"}).registerViewClass(o,t).addRoute(o,"_defaultHandler:"+o).insertPageOrder(o,{pos:"AFTER",relatedAction:i.ec.currentAction}),i.navigate(o)
},_getMaxSlideID:function(){for(var e=this.gec.getPageOrder(),t=e.length-1,n=1;t>=0;)/^slide(\d+)$/.test(e[t])&&RegExp.$1-0>n&&(n=RegExp.$1-0),t--;return n},getUniqueSlideID:function(){var e=this;return void 0===e._uniqueSlideID&&(e._uniqueSlideID=e._getMaxSlideID()),++e._uniqueSlideID}}),d=i.SubView.extend({className:"image-upload-container",init:function(e){var t=this;t._super(e),t.render(),t.$form=t.$("form"),t.$file=t.$("input"),t.$cancelButton=t.$(".cancel")},tpl:['<form action="'+global_greetingcard_server+'"',' enctype="multipart/form-data"',' method="POST" target="__hidden_iframe__">','<input class="file-input" name="image" type="file" accept="image/gif,image/jpeg,image/jpg">','<div class="fake-file-input">点击拍照或上传图片</div>','<div class="cancel">取消</div>','<input name="action" type="hidden" value="uploadimg">','<input name="redirect" type="hidden"',' value="'+global_land_page+'">','<input name="maxwidth" type="hidden" value="800">',"</form>"].join(""),render:function(){var e=this;
e._super(),e.$el.append(e.tpl),e.ensureHiddenIFrame()},ensureHiddenIFrame:function(){n("#__hidden_iframe__").length||n('<iframe id="__hidden_iframe__" name="__hidden_iframe__" style="display:none;"></iframe>').appendTo("body")},registerEvents:function(){var e=this,t=e._parent;e._super(),t.on("typechange",e.ontypechange,e),e.$file.on("change",function(){e.onchange()}),e.$cancelButton.on("click",function(){t.close()})},onchange:function(){var e=this;e.$form.submit(),window.__cardAsyncCallback__=function(t){(!t||t.imgurl)&&e._parent.trigger("confirm",{url:t.imgurl,w:t.w,h:t.h})
}},ontypechange:function(e){var t=this;e&&"local"==e.type?t.show():t.hide()},toggle:function(e){var t=this;t._super(),"none"!=t.$el.css("display")?t.open(e):t.close()},open:function(){this.show()},close:function(){this.hide()}}),f=i.SubView.extend({className:"image-url-container",events:{"click .confirm":"onconfirmclick"},init:function(){var e=this;e._super(),e.render(),e.$text=e.$("textarea"),e.$confirm=e.$(".confirm")},tpl:["<textarea></textarea>",'<div class="confirm">确定</div>'].join(""),render:function(){var e=this;
e._super(),e.$el.append(e.tpl)},registerEvents:function(){var e=this,t=e._parent;e._super(),t.on("editimage",e.oneditimage,e),t.on("typechange",e.ontypechange,e)},onconfirmclick:function(){var e=this;e._parent.trigger("confirm",{url:e.$text.val()})},oneditimage:function(e){e&&e.url&&this.$text.val(e.url)},ontypechange:function(e){var t=this;e&&"url"==e.type?t.show():t.hide()},setValue:function(e){void 0!==e&&this.$text.val(e)},toggle:function(e){var t=this;t._super(),"none"!=t.$el.css("display")?t.open(e):t.close()
},open:function(e){this.setValue(e),this.show()},close:function(){var e=this;e.gec.trigger("afterimage.global",{src:""}),this.hide()}}),h={_getSettings:function(e,t,n){var i=this,n=n||i.$el,o={},s=n.data(e);return s!==a&&(o[t]=s),o},_setSettings:function(e,t,n,i){e&&(i=i||this.$el,e[n]!==a&&i.data(t,e[n]))},_clearSettings:function(e,t,n,i){e&&(i=i||this.$el,e[n]!==a&&i.data(t,null))},_applySettings:function(e,t,n,i){Utils.isEmpty(e)||Utils.isEmpty(e[n])||(i=i||this.$el,i.css(t,e[n]),this["_set"+n.replace(/^\w/,function(e){return e.toUpperCase()
})](e,i))}},_={_getPos:function(e){var t=this,i={};return e=e||t.$el,n.extend(i,t._getSettings("pos_left","left",e),t._getSettings("pos_top","top",e),t._getSettings("pos_right","right",e),t._getSettings("pos_bottom","bottom",e)),i},_getSize:function(e){var t=this,i={};return e=e||t.$el,n.extend(i,t._getSettings("size_width","width",e),t._getSettings("size_height","height",e)),i},_getZIndex:function(e){var t=this;return e=e||t.$el,t._getSettings("layer_zindex","zIndex",e)},_getRotate:function(e){var t=this;
return e=e||t.$el,t._getSettings("transform_rotate","rotate",e)},_getLockTag:function(e){var t=this;return e=e||t.$el,t._getSettings("lock","lock",e)},_getBoxAlign:function(e){var t=this,i={};return e=e||t.$el,n.extend(i,t._getSettings("pos_boxalign_center","boxAlignCenter",e),t._getSettings("pos_boxalign_left","boxAlignLeft",e),t._getSettings("pos_boxalign_right","boxAlignRight",e),t._getSettings("pos_boxalign_bottom","boxAlignBottom",e),t._getSettings("pos_boxalign_center_a","boxAlignCenterA",e),t._getSettings("pos_boxalign_left_a","boxAlignLeftA",e),t._getSettings("pos_boxalign_right_a","boxAlignRightA",e),t._getSettings("pos_boxalign_bottom_a","boxAlignBottomA",e)),i
},_setPos:function(e,t){var n=this;t=t||n.$el,n._setSettings(e,"pos_left","left",t),n._setSettings(e,"pos_top","top",t),n._setSettings(e,"pos_right","right",t),n._setSettings(e,"pos_bottom","bottom",t)},_setSize:function(e,t){var n=this;t=t||n.$el,n._setSettings(e,"size_width","width",t),n._setSettings(e,"size_height","height",t)},_setBoxAlign:function(e,t){var n=this;t=t||n.$el,n._setSettings(e,"pos_boxalign_center","boxAlignCenter",t),n._setSettings(e,"pos_boxalign_left","boxAlignLeft",t),n._setSettings(e,"pos_boxalign_right","boxAlignRight",t),n._setSettings(e,"pos_boxalign_bottom","boxAlignBottom",t),n._setSettings(e,"pos_boxalign_center_a","boxAlignCenterA",t),n._setSettings(e,"pos_boxalign_left_a","boxAlignLeftA",t),n._setSettings(e,"pos_boxalign_right_a","boxAlignRightA",t),n._setSettings(e,"pos_boxalign_bottom_a","boxAlignBottomA",t)
},_setZIndex:function(e,t){var n=this;return t=t||n.$el,n._setSettings(e,"layer_zindex","zIndex",t)},_setRotate:function(e,t){var n=this;return t=t||n.$el,n._setSettings(e,"transform_rotate","rotate",t)},_setLockTag:function(e,t){var n=this;return t=t||n.$el,n._setSettings(e,"lock","lock",t)},_clearBoxAlign:function(e,t){var n=this;t=t||n.$el,n._clearSettings(e,"pos_boxalign_center","boxAlignCenter",t),n._clearSettings(e,"pos_boxalign_left","boxAlignLeft",t),n._clearSettings(e,"pos_boxalign_right","boxAlignRight",t),n._clearSettings(e,"pos_boxalign_bottom","boxAlignBottom",t),n._clearSettings(e,"pos_boxalign_center_a","boxAlignCenterA",t),n._clearSettings(e,"pos_boxalign_left_a","boxAlignLeftA",t),n._clearSettings(e,"pos_boxalign_right_a","boxAlignRightA",t),n._clearSettings(e,"pos_boxalign_bottom_a","boxAlignBottomA",t)
},_clearBoxAlignAll:function(e,t){var n=this;e=e||n.$el,t?n._clearBoxAlign({boxAlignBottom:1,boxAlignBottomA:1},e):n._clearBoxAlign({boxAlignCenter:1,boxAlignRight:1,boxAlignLeft:1,boxAlignCenterA:1,boxAlignRightA:1,boxAlignLeftA:1},e)},_clearLockTag:function(e,t){var n=this;!Utils.isEmpty(e)&&e.lock&&(t=t||n.$el,n._clearSettings(e,"lock","lock",t),n._isLocked=!1,n.$lockButton.html("&#xf0195;").removeClass("locked").addClass("unlocked"))},_applyPos:function(e,t){if(!Utils.isEmpty(e)){var i=n.extend({position:"absolute"},e);
t=t||this.$el,t.css(i),this._setPos(e,t)}},_applySize:function(e,t){if(!Utils.isEmpty(e)){var i=n.extend({position:"absolute"},e);t=t||this.$el,t.css(i),this._setSize(e,t)}},_applyBoxAlign:function(e){function t(){if(!n.ec.isActivePage())return void setTimeout(t,50);if(e.boxAlignCenter){var i=n.$el.width(),o=n.ec.$el.width();n._applyPos({left:(o-i)/2,right:"auto"})}else if(e.boxAlignLeft)n._applyPos({left:0,right:"auto"});else if(e.boxAlignRight)n._applyPos({right:0,left:"auto"});else if(e.boxAlignBottom)n._applyPos({bottom:0,top:"auto"});
else if(e.boxAlignCenterA!=a){var o=n.ec.$el.width(),s=parseInt(e.boxAlignCenterA);n._applyPos({left:o/2-s,right:"auto"})}else if(e.boxAlignLeftA!=a){var s=parseInt(e.boxAlignLeftA);n._applyPos({left:0-s,right:"auto"})}else if(e.boxAlignRightA!=a){var s=parseInt(e.boxAlignRightA);n._applyPos({right:0-s,left:"auto"})}else if(e.boxAlignBottomA!=a){var s=parseInt(e.boxAlignBottomA);n._applyPos({bottom:0-s,top:"auto"})}n._setBoxAlign(e)}if(!Utils.isEmpty(e)){var n=this;t()}},_applyZIndex:function(e,t){Utils.isEmpty(e)||(t=t||this.$el,t.css(e),this._setZIndex(e,t))
},_applyRotate:function(e,t){Utils.isEmpty(e)||(t=t||this.$el,t.css("-webkit-transform","rotate("+e.rotate+"deg)"),this._setRotate(e,t))},_applyLockTag:function(e,t){var n=this;t=t||n.$el,Utils.isEmpty(e)?n._clearLockTag({lock:"lock"},t):(n._isLocked=!0,n._setLockTag(e,t),n.$lockButton.html("&#xf00c9;").removeClass("unlocked").addClass("locked"))}};n.extend(_,h);var v={_setFontSize:function(e,t){this._setSettings(e,"text_font_size","fontSize",t)},_setLineHeight:function(e,t){this._setSettings(e,"text_line_height","lineHeight",t)
},_setColor:function(e,t){this._setSettings(e,"text_color","color",t)},_setTextAlign:function(e,t){this._setSettings(e,"text_align","textAlign",t)},_setBackgroundColor:function(e,t){this._setSettings(e,"background_color","backgroundColor",t)},_setBackgroundImage:function(e,t){this._setSettings(e,"background_image","backgroundImage",t)},_setBackgroundPosition:function(e,t){this._setSettings(e,"background_position","backgroundPosition",t)},_setBackgroundRepeat:function(e,t){this._setSettings(e,"background_repeat","backgroundRepeat",t)
},_getFontSize:function(e){return this._getSettings("text_font_size","fontSize",e)},_getLineHeight:function(e){return this._getSettings("text_line_height","lineHeight",e)},_getColor:function(e){return this._getSettings("text_color","color",e)},_getTextAlign:function(e){return this._getSettings("text_align","textAlign",e)},_getBackgroundColor:function(e,t){return this._getSettings(e,"background_color","backgroundColor",t)},_getBackgroundImage:function(e,t){return this._getSettings(e,"background_image","backgroundImage",t)
},_getBackgroundPosition:function(e,t){return this._getSettings(e,"background_position","backgroundPosition",t)},_getBackgroundRepeat:function(e,t){return this._getSettings(e,"background_repeat","backgroundRepeat",t)},_applyFontSize:function(e,t){this._applySettings(e,"font-size","fontSize",t)},_applyLineHeight:function(e,t){this._applySettings(e,"line-height","lineHeight",t)},_applyColor:function(e,t){this._applySettings(e,"color","color",t)},_applyTextAlign:function(e,t){this._applySettings(e,"text-align","textAlign",t)
},_applyBackgroundColor:function(e,t){this._applySettings(e,"background-color","backgroundColor",t)},_applyBackgroundImage:function(e,t){this._applySettings(e,"background-image","backgroundImage",t)},_applyBackgroundPosition:function(e,t){this._applySettings(e,"background-position","backgroundPosition",t)},_applyBackgroundRepeat:function(e,t){this._applySettings(e,"background-repeat","backgroundRepeat",t)}};n.extend(v,h);var b=i.PageView.extend({className:"slide",init:function(e){var t=this;t._super(e),t.setupSubViews(),setTimeout(function(){if(!t.viewClass||!Utils.isString(t.viewClass))throw Error('BaseSlidePageView.init: "viewClass" is undefined or is not of type String')
},0)},registerEvents:function(){var e=this,t=e.gec;t.on("slideoperation.global",e.onslideoperation,e),t.on("slidebgcolor.global",e.onslidebgcolor,e),t.on("release.global",e.onrelease,e),t.on("save4partialedit.global",e.onsave4partialedit,e),t.on("save.global",e.onsave,e),t.on("newtext.global",e.onnewtext,e),t.on("newimage.global",e.onnewimage,e),t.on("newbutton.global",e.onnewbutton,e)},unregisterEvents:function(){var e=this,t=e.gec;t.off("slideoperation.global",e.onslideoperation,e),t.off("slidebgcolor.global",e.onslidebgcolor,e),t.off("release.global",e.onrelease,e),t.off("save4partialedit.global",e.onsave4partialedit,e),t.off("save.global",e.onsave,e),t.off("newtext.global",e.onnewtext,e),t.off("newimage.global",e.onnewimage,e),t.off("newbutton.global",e.onnewbutton,e)
},setupSubViews:function(){var e=this;e.$el.children().each(function(t,i){var a=n(i).data("view_class");a&&Utils.isFunction(o[a])&&e.append(new(o[a].extend({el:i}))({isSetup:!0},e),!0)})},onslideoperation:function(e){var t=this;if(t.isActivePage())switch(e.action){case"delete":t.destroy();break;case"prev":t.goPrev();break;case"next":t.goNext()}},onslidebgcolor:function(e){var t=this;e&&e.color&&t.isActivePage()&&t._applyBackgroundColor({backgroundColor:e.color})},onsave:function(e){var t=this;e[t.action]={"class":t.viewClass,html:t.$el.prop("outerHTML").replace(/style="display: block;"/,"")}
},onrelease:function(e){this.onsave(e)},onsave4partialedit:function(e){this.onsave(e)},onnewtext:function(e){var t,n=this;if(n.isActivePage()){switch(e.type){case"topnewsimagetext":t=V;break;default:t=B}n.append(new t({pos:{top:100,left:50},size:{height:30,width:200},text:{lineHeight:"36px",color:"#fff",textAlign:"center",fontSize:"26px"}},n),!0)}},onnewbutton:function(e){var t,n=this;if(n.isActivePage()){switch(e.type){case"release":t=C;break;case"share":t=R;break;case"link-1":t=L;break;default:t=z
}n.append(new t({pos:{top:100,left:50},size:{height:30,width:160},text:{lineHeight:"30px",color:"#666",textAlign:"center",fontSize:"18px"}},n),!0)}},onnewimage:function(e){var t,n=this,i={height:100,width:150};switch(e.type){case"withmask":t=S;break;case"button":t=A,i.height=50;break;case"button-1":t=P,i.height=50;case"button-2":t=E,i.height=50;break;case"topnews-withmask":t=y;break;default:t=k}n.isActivePage()&&e.url&&n.append(new t({pos:{top:160,left:50},size:i,text:{textAlign:"center"},data:{url:e.url,w:e.w,h:e.h}},n),!0)
},goNext:function(e){this.navigate(this._getAction("NEXT"),e)},goPrev:function(e){this.navigate(this._getAction("PREV"),e)},_getAction:function(e){var t,n=this,i=n.gec.getPageOrder(),a=0;switch(e){case"PREV":t=1;case"NEXT":for(;a<i.length;){if(i[a]==n.action)return t?i[a>0?a-1:a]:i[a<i.length-1?a+1:a];a++}default:return/\d+/.test(e)?i[e]:n.action}},destroy:function(){var e=this,t=e._getAction("PREV");t!=e.action||(t=e._getAction("NEXT"))!=e.action?(e.navigate(t,{replace:!0}),setTimeout(function(){delete e._router.views[e.action],e.gec.removeRoute(e.action).removePageOrder(e.action),b._superClass.prototype.destroy.apply(e)
},1e3)):e.tip("Only 1 slide left !")}});n.extend(b.prototype,v);var m=b.extend({events:{swipeDown:"onswipeDown",swipeUp:"onswipeUp"},init:function(e){this._super(e),this.viewClass="PlainPageView"},registerEvents:function(){var e=this;e._super()},onswipeUp:function(e){var t=this;("RELEASE"==t.gec.editMode||"PARTIALEDIT"==t.gec.editMode)&&(t.goNext(),e.preventDefault())},onswipeDown:function(e){var t=this;("RELEASE"==t.gec.editMode||"PARTIALEDIT"==t.gec.editMode)&&(t.goPrev(),e.preventDefault())}}),x=m.extend({events:{swipeDown:"onswipeDown",swipeUp:"onswipeUp"},tpl:['<h2 style="margin-top:80px; color: #f00; font-size:32px;">FrontPageView</h2>'].join(""),init:function(e){this._super(e),this.viewClass="FrontPageView",this.render()
},render:function(){var e=this;e.isSetup||(e._super(),e.$el.html(e.tpl),e.append(new B({pos:{top:200,left:20},size:{height:36,width:200},text:{lineHeight:"36px",color:"#0f0",textAlign:"center",fontSize:"26px"}},e),!0))}}),$=m.extend({init:function(e){this._super(e),this.viewClass="EditOnlyPlainPageView"},onrelease:function(){var e=this;e.gec.removePageOrder(e.action)}}),w=i.SubView.extend({events:{},panelTpl:['<div class="iconfont control-panel">','<span class="lock">&#xf0195;</span>','<span class="delete">&#xf013f;</span>','<span class="resize">&#xf0005;</span>','<span class="rotate">&#xf013b;</span>','<span class="counter-rotate">&#xf013a;</span>',"</div>"].join(""),init:function(e){var t=this;
e||(e={}),t._isSetup=e.isSetup||!1,t._isRelease="RELEASE"==t.gec.editMode,t._isPartialEdit="PARTIALEDIT"==t.gec.editMode,t._isFullEdit="FULLEDIT"==t.gec.editMode,t._setPos(e.pos),t._setSize(e.size),t._isSetup||t.$el.html(t.panelTpl),t.$panel=t.$(".control-panel"),t.$resizeButton=t.$(".resize"),t.$deleteButton=t.$(".delete"),t.$lockButton=t.$(".lock"),t.$rotateButton=t.$(".rotate"),t.$counterRotateButton=t.$(".counter-rotate"),t.$resizeHandle=t.$(".resize-handle"),t.$panel.hide(),t._applyLockTag(t._getLockTag()),t._isRelease?t.$resizeHandle.hide():t._isPartialEdit&&t.$resizeHandle.hide(),setTimeout(function(){if(!t.viewClass||!Utils.isString(t.viewClass))throw Error('RectSubView.init: "viewClass" is undefined or is not of type String');
t.$el.data("view_class",t.viewClass)},0),t.render(e)},render:function(){var e=this;setTimeout(function(){e._applyPos(e._getPos()),e._applySize(e._getSize()),e._applyRotate(e._getRotate()),e._applyBoxAlign(e._getBoxAlign()),e._applyZIndex(n.extend({zIndex:10},e._getZIndex()))},200)},onclick:function(){var e=this;e.showBorder(),e.isSelected=!0,e.$el.enableDrag({ondrag:function(){e.ondrag.apply(e,arguments)}})},ensureResizeHandle:function(){var e=this;e.$resizeHandle.length||(e.$el.append('<div class="iconfont resize-handle">&#xf0154;</div>'),e.$resizeHandle=e.$(".resize-handle").hide())
},showBorder:function(){this.$el.css("border","1px dotted #fff").css("box-shadow","0px 0px 9px #000")},hideBorder:function(){this.$el.css("border","1px dotted transparent").css("box-shadow","none")},registerEvents:function(){var e=this;e._isFullEdit&&e.$el.on("click",function(){e.gec.trigger("clear.global",{target:e}),e.$panel.show(),e.onclick.apply(e,arguments)}),e._isRelease||(e.gec.on("zoom.global",e.onzoom,e),e.gec.on("layer.global",e.onlayer,e),e.gec.on("boxalign.global",e.onboxalign,e),e.gec.on("clear.global",e.onclear,e),e.ec.on("pagebeforechange",e.onpagebeforechange,e),e.$resizeButton.on("touchstart",function(t){e.gec.trigger("clear.global",{target:e}),e.$resizeButton.addClass("on"),setTimeout(function(){e.$resizeButton.removeClass("on")
},300),e.ensureResizeHandle(),e.$resizeHandle.show(),e.showBorder(),e.$resizeHandle.enableDrag({ondragstart:function(){e.$resizeHandle.addClass("on")},ondrag:function(){e.onresizedrag.apply(e,arguments)},ondragend:function(){e.$resizeHandle.removeClass("on")}}),t.stopPropagation(),t.preventDefault()}),e.$deleteButton.on("touchstart",function(){e.$deleteButton.addClass("on"),setTimeout(function(){e.destroy()},300)}),e.$lockButton.on("touchstart",function(){var t=e.$lockButton;t.hasClass("unlocked")?e._applyLockTag({lock:"lock"}):e._clearLockTag({lock:"lock"})
}),e.$rotateButton.on("touchstart",function(){e.onRotate()}),e.$counterRotateButton.on("touchstart",function(){e.onCounterRotate()}))},unregisterEvents:function(){var e=this;e._isRelease||(e.$el.off(),e.gec.off("zoom.global",e.onzoom,e),e.gec.off("layer.global",e.onlayer,e),e.gec.off("boxalign.global",e.onboxalign,e),e.gec.off("clear.global",e.onclear,e),e.ec.off("pagebeforechange",e.onpagebeforechange,e),e.$resizeButton.off(),e.$deleteButton.off(),e.$lockButton.off(),e.$resizeHandle.disableDrag(),e.$rotateButton.off())
},onpagebeforechange:function(e){var t=this,n=e.to;n==t.ec&&t.render()},onlayer:function(e){var t,n=this;if(e&&n.isSelected){switch(t=parseInt(n.$el.css("z-index"))||0,e.action){case"up":t++;break;case"down":t--;break;default:return}n._applyZIndex({zIndex:t})}},onclear:function(e){var t=this;e&&e.target==t||t.$panel.hide(),t.$el.disableDrag(),t.isSelected=!1,t.$resizeHandle&&t.$resizeHandle.hide().disableDrag(),(!t._isPartialEdit||t._isLocked)&&t.hideBorder()},ondrag:function(e,t){var n=this,i=parseInt(n.$el.css("top"))||n.$el.prop("offsetTop")||0,a=parseInt(n.$el.css("left"))||n.$el.prop("offsetLeft")||0,o={top:i+t,left:a+e};
n._clearBoxAlignAll(),n._applyPos(o)},onzoom:function(e){var t=this,n=1;if(t.isSelected){"out"==e.action&&(n=-1);var i=parseInt(t.$el.css("width"))||t.$el.width(),a=parseInt(t.$el.css("height"))||t.$el.width();t.onresizedrag(20*n,20*a/i*n)}},onresizedrag:function(e,t){var n=this,i=parseInt(n.$el.css("width"))||n.$el.width(),a=parseInt(n.$el.css("height"))||n.$el.width(),o={width:i+e,height:a+t};n._applySize(o)},onboxalign:function(e){var t=this;if(t.isSelected)switch(e.type){case"left":t.positionLeft();
break;case"right":t.positionRight();break;case"center":t.positionCenter();break;case"bottom":t.positionBottom();break;case"left-a":t.positionLeftA();break;case"right-a":t.positionRightA();break;case"center-a":t.positionCenterA();break;case"bottom-a":t.positionBottomA()}},positionCenter:function(){var e=this;e._clearBoxAlignAll(),e._applyBoxAlign({boxAlignCenter:1})},positionLeft:function(){var e=this;e._clearBoxAlignAll(),e._applyBoxAlign({boxAlignLeft:1})},positionRight:function(){var e=this;e._clearBoxAlignAll(),e._applyBoxAlign({boxAlignRight:1})
},positionBottom:function(){var e=this;e._clearBoxAlignAll(null,1),e._applyBoxAlign({boxAlignBottom:1})},positionCenterA:function(){var e=this;left=parseInt(e.$el.css("left"))||e.$el.prop("offsetLeft")||0,slideWidth=e.ec.$el.width(),dist=slideWidth/2-left,e._clearBoxAlignAll(),e._applyBoxAlign({boxAlignCenterA:dist})},positionLeftA:function(){var e=this,t=parseInt(e.$el.css("left"))||e.$el.prop("offsetLeft")||0,n=0-t;e._clearBoxAlignAll(),e._applyBoxAlign({boxAlignLeftA:n})},positionRightA:function(){var e=this,t=parseInt(e.$el.css("width"))+2||e.$el.prop("offsetWidth")+2,n=parseInt(e.$el.css("left"))||e.$el.prop("offsetLeft")||0,i=e.ec.$el.width(),a=i-t-n,o=0-a;
e._clearBoxAlignAll(),e._applyBoxAlign({boxAlignRightA:o})},positionBottomA:function(){var e=this,t=parseInt(e.$el.css("height"))+2||e.$el.prop("offsetHeight")+2,n=parseInt(e.$el.css("top"))||e.$el.prop("offsetTop")||0,i=e.ec.$el.height(),a=i-t-n,o=0-a;e._clearBoxAlignAll(null,1),e._applyBoxAlign({boxAlignBottomA:o})},onRotate:function(e){var t=this,n=e?-1:1,i=3*n,a=t._getRotate();a.rotate=((a.rotate||0)-0+i)%360,t._applyRotate(a)},onCounterRotate:function(){var e=this;e.onRotate(1)}});n.extend(w.prototype,_);
var k=w.extend({events:{},tpl:['<div class="image">',"<img>","</div>",'<div class="inner-panel iconfont">','<span class="img-move" data-btn-type="img-move">&#xf01b6;</span>','<span class="img-upload" data-btn-type="img-upload">&#xf0024;</span>','<span data-btn-type="img-zoom-in">&#xf01b9;</span>','<span data-btn-type="img-zoom-out">&#xf01b8;</span>','<span data-btn-type="img-rotate">&#xf013b;</span>','<span data-btn-type="img-counter-rotate">&#xf013a;</span>',"</div>",'<div class="loading-layer"></div>'].join(""),init:function(e){var t=this;
e||(e={}),t._super(e),t.viewClass="ImageSubView",t._isSetup||(t.$el.append(t.tpl),t.$panel.append('<span class="edit">&#xf0022;</span>')),t.$image=t.$(".image"),t.$img=t.$("img"),t.$editButton=t.$(".edit"),t.$loading=t.$(".loading-layer"),t.initImage(e),t.$innerPanel=t.$(".inner-panel"),t.$imgMove=t.$innerPanel.find(".img-move").removeClass("on").show(),(t._isRelease||t._isPartialEdit&&t._isLocked)&&t.$innerPanel.hide()},render:function(e){var t=this;t._super(),setTimeout(function(){t.applyTextSettings(e&&e.image)
},200)},initImage:function(e){var t=this;e.data&&e.data.url&&(setTimeout(function(){t.$loading.show()},0),setTimeout(function(){var n=e.data;t.$img.attr("src",n.url).show().on("load",function(){t.$loading.hide()}),n.w&&t.$img.data("natural-width",n.w),n.h&&t.$img.data("natural-height",n.h)},3e3))},registerEvents:function(){var e=this,t=e.gec,i=e.ec;e._super(),e._isRelease||(e._isPartialEdit&&!e._isLocked&&e.$el.on("click",function(t){t.stopPropagation(),t.preventDefault(),e.uploadImage()}),i.on("pagebeforechange",e.onpagebeforechange,e),t.on("textalign.global",e.ontextalign,e),t.on("imagechange.global",e.onimagechange,e),t.on("release.global save4partialedit.global save.global",e.onrelease,e),e.$editButton.on("touchstart",function(t){t.stopPropagation(),t.preventDefault(),e.gec.trigger("clear.global",{target:e}),e.isSelected=!0,e.$editButton.addClass("on"),setTimeout(function(){e.$editButton.removeClass("on")
},300),e.isEdited=!0,e.gec.trigger("beforeimageedit.global",{url:e.$img.attr("src")})}),e.$innerPanel.on("touchstart",function(t){if(t.preventDefault(),t.stopPropagation(),!e.innerPanelLocked){e.innerPanelLocked=!0;var i=n(t.target).closest("span");switch(i.data("btn-type")){case"img-move":e.toggleImageMove(i);break;case"img-upload":e.uploadImage();break;case"img-zoom-in":e.imgZoomIn();break;case"img-zoom-out":e.imgZoomOut();break;case"img-rotate":e.imgRotate();break;case"img-counter-rotate":e.imgCounterRotate()
}setTimeout(function(){e.innerPanelLocked=!1},300)}}))},unregisterEvents:function(){var e=this,t=e.ec,n=e.gec;e._isRelease||(t.off("pagebeforechange",e.onpagebeforechange,e),n.off("textalign.global",e.ontextalign,e),n.off("imagechange.global",e.onimagechange,e),n.off("release.global save4partialedit.global save.global",e.onrelease,e),e.$editButton.off(),e.$innerPanel.off(),e._super())},onimagechange:function(e){var t=this;e&&e.url&&t.isSelected&&t.isEdited&&(setTimeout(function(){t.$loading.show()
},0),setTimeout(function(){t.$img.attr("src",e.url).show().on("load",function(){t.$loading.hide()}),e.w&&t.$img.data("natural-width",e.w),e.h&&t.$img.data("natural-height",e.h),t.isEdited=!1},3e3))},onrelease:function(e,t){var n=this;t.push(n.$img.attr("src"))},onpagebeforechange:function(e){var t=this;e.to,t._super(e)},ontextalign:function(e){var t=this;t.isSelected&&t._applyTextAlign(e)},applyTextSettings:function(e){var t=this;t._applyTextAlign(e||t._getTextAlign())},uploadImage:function(){var e=this;
e.gec.trigger("clear.global",{target:e}),e.isSelected=!0,e.isEdited=!0,e.gec.trigger("beforeimageedit.global",{url:e.$img.attr("src")})},enableImageDrag:function(){var e=this;e.gec.trigger("clear.global",{target:e}),e.$img.enableDrag({ondrag:function(){e.onimgdrag.apply(e,arguments)}})},onimgdrag:function(e,t){var n=this,i=n.$img,a=parseInt(i.css("top"))||i.prop("offsetTop")||0,o=parseInt(i.css("left"))||i.prop("offsetLeft")||0,s={top:a+t,left:o+e};n._applyPos(s,i)},imgZoomIn:function(){var e=this,t=parseInt(e.$img.css("width"))||e.$img.width(),n={width:1.02*t};
e._applySize(n,e.$img)},imgZoomOut:function(){var e=this,t=parseInt(e.$img.css("width"))||e.$img.width(),n={width:.98*t};e._applySize(n,e.$img)},imgRotate:function(e){var t=this,n=e?-1:1,i=3*n,a=t._getRotate(t.$img);a.rotate=((a.rotate||0)-0+i)%360,t._applyRotate(a,t.$img)},imgCounterRotate:function(){var e=this;e.imgRotate(1)},onclear:function(){var e=this;e._super(),e.$img.disableDrag()},toggleImageMove:function(e){var t=this;t.gec.trigger("clear.global",{target:t}),t.isEnableImageMove=!t.isEnableImageMove,t.isEnableImageMove?(e.addClass("on"),t.enableImageDrag()):e.removeClass("on")
}});n.extend(k.prototype,v);var S=k.extend({maskImageTpl:['<div class="img-mask">','<span class="img-mask-change">换蒙层</span>',"</div>"].join(""),init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ImageWithMaskSubView",t._isSetup||t.$el.append(t.maskImageTpl),t.$imgMask=t.$(".img-mask"),t.$changeMaskBtn=t.$(".img-mask-change"),(t._isRelease||t._isPartialEdit)&&t.$changeMaskBtn.hide()},render:function(){var e=this;e._super()},registerEvents:function(){var e=this;e.gec,e.ec,e._super(),e._isRelease||e._isPartialEdit||e.$changeMaskBtn.on("touchstart",function(t){t.stopPropagation(),t.preventDefault(),e.gec.trigger("clear.global",{target:e}),e.isSelected=!0,e.$changeMaskBtn.addClass("on"),setTimeout(function(){e.$changeMaskBtn.removeClass("on")
},300),e.isMaskEdited=!0,e.gec.trigger("beforeimageedit.global",{url:e.$imgMask.attr("src")})})},unregisterEvents:function(){var e=this;e.ec,e.gec,e.$changeMaskBtn.off(),e._super()},onimagechange:function(e){var t=this;t._super(e),e&&e.url&&t.isSelected&&t.isMaskEdited&&(setTimeout(function(){t.$loading.show()},0),setTimeout(function(){var n=new Image;n.src=e.url,n.onload=function(){t.$loading.hide()},t._applyBackgroundImage({backgroundImage:"url("+e.url+")"},t.$imgMask),e.w&&t.$imgMask.data("natural-width",e.w),e.h&&t.$imgMask.data("natural-height",e.h),t.isMaskEdited=!1
},3e3))},onrelease:function(e,t){var n=this,i=n.$imgMask.css("background-image").replace(/url\("?|"?\)/g,"");n._super(e,t),"none"!=i&&t.push(i)},enableImageMaskDrag:function(){var e=this;e.$imgMask.enableDrag({ondrag:function(){e.onimgdrag.apply(e,arguments)}})},toggleImageMove:function(e){var t=this;t.gec.trigger("clear.global",{target:t}),t.isEnableImageMove=!t.isEnableImageMove,t.isEnableImageMove?(e.addClass("on"),t.enableImageMaskDrag()):e.removeClass("on")},onclear:function(e){var t=this;t._super(e),t.$imgMask.disableDrag()
}}),y=S.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="TopNewsImageWithMaskSubView"},onrelease:function(e,t,i){var a,o,s,l,r=this,c=r.$img,g=c.data("natural-width"),p=c.data("natural-height"),u=c.data("pos_top")||0,d=c.data("pos_left")||0,f=parseInt(c.css("width"))||1,h=f/g,_=c.attr("src");1!=f&&g&&(a=(-d>=0?-d:0)/h,o=(-u>=0?-u:0)/h,s=640/h,s=Math.min(s,g),l=s/1.6,console.log([h,d,u,a,o,s,l,g,p].join(", ")),n.extend(i,{x:a,y:o,w:s,h:Math.min(l,p),img_url:_,img_width:g,img_height:p}),console.log(i))
}}),A=k.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ImageButtonSubView",t._isSetup||t.$innerPanel.append('<span class="edit-link">@</span>'),t.$editLinkButton=t.$innerPanel.find(".edit-link")},registerEvents:function(){var e=this,t=e.gec;return e.ec,e._super(),e._isRelease?void e.$el.off().on("click",function(){var t=e.$el.data("link");t&&(location.href=t)}):(t.on("afteredit.global",e.onafteredit,e),void e.$editLinkButton.on("touchstart",function(t){t.stopPropagation(),t.preventDefault(),e.gec.trigger("clear.global",{target:e}),e.isSelected=!0,e.$editLinkButton.addClass("on"),setTimeout(function(){e.$editLinkButton.removeClass("on")
},300),e.isLinkEdited=!0,e.gec.trigger("beforeedit.global",{url:e.$el.data("link")})}))},unregisterEvents:function(){var e=this,t=(e.ec,e.gec);e._isRelease||(e.$editLinkButton.off(),t.off("afteredit.global",e.onafteredit,e),e._super())},onafteredit:function(e){var t=this;void 0!==e.text&&t.isLinkEdited&&t.$el.data("link",e.text),t.isLinkEdited=!1}}),P=A.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ImageReleaseOnlyButtonSubView",t._isPartialEdit?t.$el.hide():t._isRelease&&t.$el.show()
}}),E=A.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ImageEditOnlyButtonSubView",t._isPartialEdit?t.$el.show():t._isRelease&&t.$el.hide()}}),B=w.extend({events:{},textTpl:['<div class="text"></div>'].join(""),init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="TextSubView",t._isSetup||(t.$el.append(t.textTpl),t.$panel.append('<span class="edit icon-bianji"></span>')),t.$text=t.$(".text"),t.$editButton=t.$(".edit"),t._isSetup||t.$text.html("TextSubView")},render:function(e){var t=this;
t._super(),setTimeout(function(){t.applyTextSettings(e&&e.text)},200)},registerEvents:function(){var e=this,t=e.gec,n=e.ec;e._super(),e._isRelease||(e._isPartialEdit&&!e._isLocked&&e.$el.on("click",function(t){t.stopPropagation(),t.preventDefault(),e.onActivatedUnderPartialEdit()}),e.$editButton.on("touchstart",function(t){t.stopPropagation(),t.preventDefault(),e.gec.trigger("clear.global",{target:e}),e.$editButton.addClass("on"),setTimeout(function(){e.$editButton.removeClass("on")},300),e.isEdited=!0,e.gec.trigger("beforeedit.global",{text:e.$text.html()})
}),n.on("pagebeforechange",e.onpagebeforechange,e),t.on("textalign.global",e.ontextalign,e),t.on("color.global",e.oncolor,e),t.on("fontsize.global",e.onfontsize,e),t.on("lineheight.global",e.onlineheight,e),t.on("afteredit.global",e.onafteredit,e))},unregisterEvents:function(){var e=this,t=e.ec,n=e.gec;e._isRelease||(e.$editButton.off(),t.off("pagebeforechange",e.onpagebeforechange,e),n.off("textalign.global",e.ontextalign,e),n.off("color.global",e.oncolor,e),n.off("fontsize.global",e.onfontsize,e),n.off("lineheight.global",e.onlineheight,e),n.off("afteredit.global",e.onafteredit,e),e._super())
},onpagebeforechange:function(e){this._super(e)},onafteredit:function(e){var t=this;void 0!==e.text&&t.isEdited&&t.$text.html(e.text),t.isEdited=!1},onfontsize:function(e){var t=this;t.isSelected&&t._applyFontSize(e)},onlineheight:function(e){var t=this;t.isSelected&&t._applyLineHeight(e)},ontextalign:function(e){var t=this;t.isSelected&&t._applyTextAlign(e)},oncolor:function(e){var t=this;t.isSelected&&t._applyColor(e)},applyTextSettings:function(e){var t=this;t._applyFontSize(e||t._getFontSize()),t._applyLineHeight(e||t._getLineHeight()),t._applyColor(e||t._getColor()),t._applyTextAlign(e||t._getTextAlign())
},onActivatedUnderPartialEdit:function(){var e=this;e.gec.trigger("clear.global",{target:e}),e.isSelected=!0,e.isEdited=!0,e.gec.trigger("beforeedit.global",{text:e.$text.html()})}});n.extend(B.prototype,v);var I=B.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ReleaseOnlyButtonSubView",t._isSetup||t.$text.html("仅发布模式可见"),t._isPartialEdit?t.$el.hide():t._isRelease&&t.$el.show()}}),T=B.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="PartialEditOnlyButtonSubView",t._isSetup||t.$text.html("仅编辑模式可见"),t._isRelease&&t.$el.hide()
}}),C=B.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ReleaseButtonSubView",t._isSetup||t.$text.html("发布")},registerEvents:function(){var e=this,t=e.gec;return e.ec,e._super(),e._isPartialEdit?void e.$el.off().on("click",function(){t.trigger("release.releasebutton.global")}):void 0},unregisterEvents:function(){var e=this;e.ec,e.gec,e._isPartialEdit&&e.$el.off(),e._super()}}),R=I.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="ShareButtonSubView",t._isSetup||t.$text.html("分享")
},registerEvents:function(){var e=this;return e.gec,e.ec,e._super(),e._isRelease?void e.$el.off().on("click",function(){location.href="http://m.baidu.com/news"+location.search}):void 0},unregisterEvents:function(){var e=this;e.ec,e.gec,e._isRelease&&e.$el.off(),e._super()}}),z=B.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="LinkButtonSubView",t._isSetup||(t.$text.html("链接按钮"),t.$panel.append('<span class="edit-link">@</span>')),t.$editLinkButton=t.$(".edit-link"),t._isPartialEdit&&!t._isLocked&&t.showLinkEdit()
},registerEvents:function(){var e=this;return e.gec,e.ec,e._super(),e._isRelease?void e.$el.off().on("click",function(){var t=e.$text.data("link");t&&(location.href=t)}):void e.$editLinkButton.on("touchstart",function(t){t.stopPropagation(),t.preventDefault(),e.gec.trigger("clear.global",{target:e}),e.$editButton.addClass("on"),setTimeout(function(){e.$editButton.removeClass("on")},300),e.isLinkEdited=!0,e.gec.trigger("beforeedit.global",{text:e.$text.data("link")})})},unregisterEvents:function(){var e=this;
e.ec,e.gec,e._isPartialEdit&&e.$el.off(),e.$editLinkButton.off(),e._super()},showLinkEdit:function(){var e=this;e.$panel.show().find("span").each(function(e,t){n(t).hide()}),e.$editLinkButton.show()},hideLinkEdit:function(){this.$panel.hide()},onclear:function(e){var t=this;t._super(e),e&&e.target==t||t.hideLinkEdit()},onafteredit:function(e){var t=this;t._super(e),void 0!==e.text&&t.isLinkEdited&&t.$text.data("link",e.text),t.isLinkEdited=!1},onActivatedUnderPartialEdit:function(){var e=this;e._super(),e.showLinkEdit()
}}),L=z.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="LinkReleaseOnlyButtonSubView",t._isSetup||t.$text.html("仅发布模式可见"),t._isPartialEdit?t.$el.hide():t._isRelease&&t.$el.show()}}),V=B.extend({init:function(e){var t=this;e||(e={}),t._super(e),t.viewClass="TopNewsImageTextSubView"},registerEvents:function(){var e=this,t=e.gec;e.ec,e._super(),e._isRelease||t.on("release.global save4partialedit.global save.global",e.onrelease,e)},unregisterEvents:function(){var e=this,t=(e.ec,e.gec);
e._isRelease||(t.off("release.global save4partialedit.global save.global",e.onrelease,e),e._super())},onrelease:function(e,t,n){n.title=this.$text.text()}});return n.extend(o,{RectSubView:w,ImageSubView:k,ImageWithMaskSubView:S,TopNewsImageWithMaskSubView:y,ImageButtonSubView:A,ImageReleaseOnlyButtonSubView:P,ImageEditOnlyButtonSubView:E,TextSubView:B,PartialEditOnlyButtonSubView:T,ReleaseOnlyButtonSubView:I,TopNewsImageTextSubView:V,ReleaseButtonSubView:C,LinkButtonSubView:z,LinkReleaseOnlyButtonSubView:L,ShareButtonSubView:R}),{PanelGlobalView:s,PlainPageView:m,FrontPageView:x,EditOnlyPlainPageView:$}
});